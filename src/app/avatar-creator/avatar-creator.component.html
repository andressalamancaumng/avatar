<!-- src/app/avatar-creator/avatar-creator.component.html -->

<!-- Loading Screen -->
<div class="loading-screen" *ngIf="isLoading">
  <div class="loading-content">
    <div class="dna-container">
      <div class="dna-helix">
        <div class="dna-strand"></div>
        <div class="dna-strand"></div>
      </div>
    </div>
    <h1 class="loading-title">Cargando el ADN del campus</h1>
    <div class="loading-bar-container">
      <div class="loading-bar" [style.width.%]="loadingProgress"></div>
    </div>
    <p class="loading-percentage">{{ loadingProgress | number:'1.0-0' }}%</p>
  </div>
</div>

<!-- Main App -->
<div class="avatar-creator" *ngIf="!isLoading">
  <!-- Header Fixed -->
  <div class="header">
    <!-- Commitment Progress Bar -->
    <div class="commitment-section">
      <label class="commitment-label">Barra de Compromiso</label>
      <div class="commitment-message">{{ commitmentMessage }}</div>
      <div class="commitment-bar-container">
        <div class="commitment-bar" [style.width.%]="commitmentProgress">
          <span class="commitment-percentage" *ngIf="commitmentProgress > 10">
            {{ commitmentProgress | number:'1.0-0' }}%
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Avatar Screen -->
  <div class="content" *ngIf="!showCustomizationScreen">
    <!-- Avatar Preview Centered -->
    <div class="avatar-preview">
      <div class="avatar-container">
        <svg viewBox="0 0 200 300" class="avatar-svg">
          <!-- Hair (behind everything) -->
          <g *ngIf="avatar.hairStyle && avatar.hairStyle !== 'bald'">
            <!-- Short Hair - Simple cap -->
            <g *ngIf="avatar.hairStyle === 'short'">
              <ellipse cx="100" cy="60" rx="50" ry="40" [attr.fill]="avatar.hairColor || '#3B2414'" />
            </g>

            <!-- Medium Hair - Extends to shoulders -->
            <g *ngIf="avatar.hairStyle === 'medium'">
              <ellipse cx="100" cy="60" rx="52" ry="42" [attr.fill]="avatar.hairColor || '#3B2414'" />
              <path d="M 52 70 L 48 110 L 65 110 L 60 75 Z" [attr.fill]="avatar.hairColor || '#3B2414'" />
              <path d="M 148 70 L 152 110 L 135 110 L 140 75 Z" [attr.fill]="avatar.hairColor || '#3B2414'" />
            </g>

            <!-- Long Hair - Extends down -->
            <g *ngIf="avatar.hairStyle === 'long'">
              <ellipse cx="100" cy="60" rx="54" ry="44" [attr.fill]="avatar.hairColor || '#3B2414'" />
              <path d="M 50 70 L 45 130 L 65 130 L 60 75 Z" [attr.fill]="avatar.hairColor || '#3B2414'" />
              <path d="M 150 70 L 155 130 L 135 130 L 140 75 Z" [attr.fill]="avatar.hairColor || '#3B2414'" />
            </g>

            <!-- Ponytail -->
            <g *ngIf="avatar.hairStyle === 'ponytail'">
              <ellipse cx="100" cy="60" rx="50" ry="40" [attr.fill]="avatar.hairColor || '#3B2414'" />
              <ellipse cx="148" cy="80" rx="12" ry="28" [attr.fill]="avatar.hairColor || '#3B2414'" transform="rotate(15 148 80)"/>
            </g>
          </g>

          <!-- Head -->
          <ellipse cx="100" cy="80" rx="45" ry="50" [attr.fill]="avatar.skinColor || '#F4C4A0'" />

          <!-- Eyes -->
          <circle cx="85" cy="75" r="5" fill="#000000" />
          <circle cx="115" cy="75" r="5" fill="#000000" />

          <!-- Hair Fringe (covers forehead but not eyes) -->
          <g *ngIf="avatar.hairStyle && avatar.hairStyle !== 'bald'">
            <!-- Short Hair Fringe -->
            <ellipse *ngIf="avatar.hairStyle === 'short'"
                     cx="100" cy="45" rx="47" ry="15"
                     [attr.fill]="avatar.hairColor || '#3B2414'" />

            <!-- Medium Hair Fringe -->
            <ellipse *ngIf="avatar.hairStyle === 'medium'"
                     cx="100" cy="45" rx="49" ry="17"
                     [attr.fill]="avatar.hairColor || '#3B2414'" />

            <!-- Long Hair Fringe -->
            <ellipse *ngIf="avatar.hairStyle === 'long'"
                     cx="100" cy="45" rx="51" ry="18"
                     [attr.fill]="avatar.hairColor || '#3B2414'" />

            <!-- Ponytail Fringe -->
            <ellipse *ngIf="avatar.hairStyle === 'ponytail'"
                     cx="100" cy="45" rx="47" ry="15"
                     [attr.fill]="avatar.hairColor || '#3B2414'" />
          </g>

          <!-- Glasses -->
          <g *ngIf="avatar.glasses">
            <rect x="75" y="70" width="20" height="15" fill="none" stroke="#333333" stroke-width="2" rx="3"/>
            <rect x="105" y="70" width="20" height="15" fill="none" stroke="#333333" stroke-width="2" rx="3"/>
            <line x1="95" y1="77" x2="105" y2="77" stroke="#333333" stroke-width="2"/>
            <line x1="75" y1="77" x2="65" y2="77" stroke="#333333" stroke-width="2"/>
            <line x1="125" y1="77" x2="135" y2="77" stroke="#333333" stroke-width="2"/>
          </g>

          <!-- Head Bandana -->
          <g *ngIf="avatar.headBandana && avatar.hairStyle && avatar.hairStyle !== 'bald'">
            <ellipse cx="100" cy="65" rx="52" ry="8" fill="#E74C3C"/>
            <circle cx="145" cy="65" r="5" fill="#C0392B"/>
          </g>
          
          <!-- Nose -->
          <line x1="100" y1="85" x2="100" y2="95" stroke="#000000" stroke-width="2" />
          
          <!-- Mouth -->
          <path d="M 90 105 Q 100 110 110 105" stroke="#000000" stroke-width="2" fill="none" />
          
          <!-- Role Badge -->
          <g *ngIf="avatar.role === 'estudiante'">
            <circle cx="135" cy="60" r="18" fill="#4A90E2" stroke="#fff" stroke-width="2"/>
            <text x="135" y="67" text-anchor="middle" font-size="20" fill="#fff">ğŸ“</text>
          </g>
          <g *ngIf="avatar.role === 'docente'">
            <circle cx="135" cy="60" r="18" fill="#E74C3C" stroke="#fff" stroke-width="2"/>
            <text x="135" y="67" text-anchor="middle" font-size="20" fill="#fff">ğŸ‘¨â€ğŸ«</text>
          </g>
          <g *ngIf="avatar.role === 'administrativo'">
            <circle cx="135" cy="60" r="18" fill="#2ECC71" stroke="#fff" stroke-width="2"/>
            <text x="135" y="67" text-anchor="middle" font-size="20" fill="#fff">ğŸ’¼</text>
          </g>
          
          <!-- Neck -->
          <rect x="85" y="125" width="30" height="15" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
          
          <!-- Shirt/Body - T-Shirt -->
          <g *ngIf="avatar.shirtType === 'tshirt'">
            <rect x="60" y="140" width="80" height="70" [attr.fill]="avatar.shirtColor || '#4A90E2'" rx="5" />
            <line x1="100" y1="140" x2="100" y2="210" stroke="#000000" stroke-width="1" opacity="0.2" />
            
            <!-- Chest Bandana for T-Shirt -->
            <g *ngIf="avatar.chestBandana">
              <rect x="75" y="155" width="50" height="8" fill="#E74C3C" rx="2"/>
              <polygon points="120,159 125,155 125,163" fill="#C0392B"/>
            </g>
          </g>
          
          <!-- Shirt/Body - Hoodie -->
          <g *ngIf="avatar.shirtType === 'hoodie'">
            <rect x="60" y="140" width="80" height="70" [attr.fill]="avatar.shirtColor || '#4A90E2'" rx="5" />
            <!-- Hood -->
            <path d="M 70 140 Q 100 125 130 140" [attr.fill]="avatar.shirtColor || '#4A90E2'" stroke="#000000" stroke-width="1" opacity="0.3"/>
            <!-- Zipper -->
            <line x1="100" y1="140" x2="100" y2="210" stroke="#666666" stroke-width="3" />
            <circle cx="100" cy="145" r="3" fill="#888888"/>
            <circle cx="100" cy="160" r="3" fill="#888888"/>
            <circle cx="100" cy="175" r="3" fill="#888888"/>
            <circle cx="100" cy="190" r="3" fill="#888888"/>
            <circle cx="100" cy="205" r="3" fill="#888888"/>
            <!-- Pockets -->
            <rect x="65" y="170" width="15" height="20" [attr.fill]="avatar.shirtColor || '#4A90E2'" stroke="#000000" stroke-width="1" opacity="0.3" rx="2"/>
            <rect x="120" y="170" width="15" height="20" [attr.fill]="avatar.shirtColor || '#4A90E2'" stroke="#000000" stroke-width="1" opacity="0.3" rx="2"/>
            
            <!-- Chest Bandana for Hoodie -->
            <g *ngIf="avatar.chestBandana">
              <rect x="75" y="155" width="50" height="8" fill="#E74C3C" rx="2"/>
              <polygon points="120,159 125,155 125,163" fill="#C0392B"/>
            </g>
          </g>
          
          <!-- Arms -->
          <rect x="40" y="145" width="20" height="60" [attr.fill]="avatar.shirtColor || '#4A90E2'" rx="10" />
          <rect x="140" y="145" width="20" height="60" [attr.fill]="avatar.shirtColor || '#4A90E2'" rx="10" />
          <circle cx="50" cy="205" r="8" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
          <circle cx="150" cy="205" r="8" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
          
          <!-- Pants/Shorts/Skirt -->
          <g>
            <!-- Regular Pants -->
            <g *ngIf="avatar.pantsType === 'pants'">
              <rect x="65" y="210" width="30" height="70" [attr.fill]="avatar.pantsColor || '#2C3E50'" />
              <rect x="105" y="210" width="30" height="70" [attr.fill]="avatar.pantsColor || '#2C3E50'" />
              <line x1="80" y1="210" x2="80" y2="280" stroke="#000000" stroke-width="1" opacity="0.2" />
              <line x1="120" y1="210" x2="120" y2="280" stroke="#000000" stroke-width="1" opacity="0.2" />
            </g>
            
            <!-- Shorts -->
            <g *ngIf="avatar.pantsType === 'shorts'">
              <rect x="65" y="210" width="30" height="40" [attr.fill]="avatar.pantsColor || '#2C3E50'" rx="3"/>
              <rect x="105" y="210" width="30" height="40" [attr.fill]="avatar.pantsColor || '#2C3E50'" rx="3"/>
              <line x1="80" y1="210" x2="80" y2="250" stroke="#000000" stroke-width="1" opacity="0.2" />
              <line x1="120" y1="210" x2="120" y2="250" stroke="#000000" stroke-width="1" opacity="0.2" />
              <!-- Legs visible -->
              <rect x="68" y="250" width="24" height="30" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
              <rect x="108" y="250" width="24" height="30" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
            </g>
            
            <!-- Skirt -->
            <g *ngIf="avatar.pantsType === 'skirt'">
              <!-- Single piece skirt -->
              <path d="M 65 210 L 55 265 L 145 265 L 135 210 Z"
                    [attr.fill]="avatar.pantsColor || '#2C3E50'"
                    stroke="#000000"
                    stroke-width="1.5"
                    opacity="0.95"/>
              <!-- Waistband -->
              <rect x="65" y="210" width="70" height="5"
                    [attr.fill]="avatar.pantsColor || '#2C3E50'"
                    opacity="0.8"/>
              <!-- Pleat lines for detail -->
              <line x1="80" y1="215" x2="70" y2="265" stroke="#000000" stroke-width="1" opacity="0.2" />
              <line x1="100" y1="215" x2="100" y2="265" stroke="#000000" stroke-width="1" opacity="0.2" />
              <line x1="120" y1="215" x2="130" y2="265" stroke="#000000" stroke-width="1" opacity="0.2" />
              <!-- Legs visible below skirt -->
              <rect x="62" y="265" width="26" height="15" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
              <rect x="112" y="265" width="26" height="15" [attr.fill]="avatar.skinColor || '#F4C4A0'" />
            </g>
          </g>
          
          <!-- Shoes -->
          <ellipse cx="80" cy="285" rx="18" ry="8" fill="#333333" />
          <ellipse cx="120" cy="285" rx="18" ry="8" fill="#333333" />
        </svg>
      </div>

      <!-- Floating Action Buttons -->
      <div class="floating-actions">
        <button (click)="openCustomizationMenu()" class="btn-fab btn-primary-fab">
          âœ¨ Personalizar
        </button>
        <button (click)="resetAvatar()" class="btn-fab btn-secondary-fab">
          ğŸ”„ Reiniciar
        </button>
        <button (click)="saveAvatar()" class="btn-fab btn-save-fab">
          ğŸ’¾ Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Customization Menu -->
  <div class="customization-menu-overlay" *ngIf="showCustomizationMenu" (click)="closeCustomizationMenu()"></div>
  <div class="customization-menu" [class.show]="showCustomizationMenu">
    <div class="menu-header">
      <h3>Opciones de PersonalizaciÃ³n</h3>
      <button (click)="closeCustomizationMenu()" class="btn-close">âœ•</button>
    </div>
    <div class="menu-content">
      <button (click)="openCustomizationScreen('role')" class="menu-item">
        <span class="menu-icon">ğŸ“</span>
        <span class="menu-text">Rol en el Campus</span>
      </button>
      <button (click)="openCustomizationScreen('skinColor')" class="menu-item">
        <span class="menu-icon">ğŸ‘¤</span>
        <span class="menu-text">Color de Piel</span>
      </button>
      <button (click)="openCustomizationScreen('hairColor')" class="menu-item">
        <span class="menu-icon">ğŸ’‡</span>
        <span class="menu-text">Color de Cabello</span>
      </button>
      <button (click)="openCustomizationScreen('hairStyle')" class="menu-item">
        <span class="menu-icon">âœ‚ï¸</span>
        <span class="menu-text">Estilo de Cabello</span>
      </button>
      <button (click)="openCustomizationScreen('shirtColor')" class="menu-item">
        <span class="menu-icon">ğŸ‘•</span>
        <span class="menu-text">Color de Camiseta</span>
      </button>
      <button (click)="openCustomizationScreen('shirtType')" class="menu-item">
        <span class="menu-icon">ğŸ½</span>
        <span class="menu-text">Tipo de Prenda Superior</span>
      </button>
      <button (click)="openCustomizationScreen('pantsType')" class="menu-item">
        <span class="menu-icon">ğŸ‘–</span>
        <span class="menu-text">Tipo de Prenda Inferior</span>
      </button>
      <button (click)="openCustomizationScreen('pantsColor')" class="menu-item">
        <span class="menu-icon">ğŸ©³</span>
        <span class="menu-text">Color de Parte Inferior</span>
      </button>
      <button (click)="openCustomizationScreen('accessories')" class="menu-item">
        <span class="menu-icon">ğŸ‘“</span>
        <span class="menu-text">Accesorios</span>
      </button>
    </div>
  </div>

  <!-- Customization Screen -->
  <div class="customization-screen" *ngIf="showCustomizationScreen">
    <div class="customization-header">
      <button (click)="closeCustomizationScreen()" class="btn-back">
        â† Volver
      </button>
      <h2>
        <span *ngIf="currentCustomizationOption === 'role'">ğŸ“ Rol en el Campus</span>
        <span *ngIf="currentCustomizationOption === 'skinColor'">ğŸ‘¤ Color de Piel</span>
        <span *ngIf="currentCustomizationOption === 'hairColor'">ğŸ’‡ Color de Cabello</span>
        <span *ngIf="currentCustomizationOption === 'hairStyle'">âœ‚ï¸ Estilo de Cabello</span>
        <span *ngIf="currentCustomizationOption === 'shirtColor'">ğŸ‘• Color de Camiseta</span>
        <span *ngIf="currentCustomizationOption === 'shirtType'">ğŸ½ Tipo de Prenda Superior</span>
        <span *ngIf="currentCustomizationOption === 'pantsType'">ğŸ‘– Tipo de Prenda Inferior</span>
        <span *ngIf="currentCustomizationOption === 'pantsColor'">ğŸ©³ Color de Parte Inferior</span>
        <span *ngIf="currentCustomizationOption === 'accessories'">ğŸ‘“ Accesorios</span>
      </h2>
      <div></div>
    </div>

    <div class="customization-content">

      <!-- Role Selection -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'role'">
        <label class="option-label">Rol en el Campus</label>
        <div class="button-group role-group">
          <button
            *ngFor="let role of roles"
            [class.active]="avatar.role === role.value"
            (click)="avatar.role = role.value; onOptionChange()"
            class="btn-option btn-role">
            <span class="role-icon">{{ role.icon }}</span>
            <span class="role-name">{{ role.name }}</span>
          </button>
        </div>
      </div>

      <!-- Skin Color -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'skinColor'">
        <label class="option-label">Color de Piel</label>
        <div class="color-grid">
          <button
            *ngFor="let color of skinColors"
            [class.active]="avatar.skinColor === color.value"
            (click)="avatar.skinColor = color.value; onOptionChange()"
            class="color-option"
            [style.background-color]="color.value"
            [attr.aria-label]="color.name">
            <span class="color-name">{{ color.name }}</span>
          </button>
        </div>
      </div>

      <!-- Hair Color -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'hairColor'">
        <label class="option-label">Color de Cabello</label>
        <div class="color-grid">
          <button
            *ngFor="let color of hairColors"
            [class.active]="avatar.hairColor === color.value"
            (click)="avatar.hairColor = color.value; onOptionChange()"
            class="color-option"
            [style.background-color]="color.value"
            [attr.aria-label]="color.name">
            <span class="color-name">{{ color.name }}</span>
          </button>
        </div>
      </div>

      <!-- Hair Style -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'hairStyle'">
        <label class="option-label">Estilo de Cabello</label>
        <div class="button-group">
          <button
            *ngFor="let style of hairStyles"
            [class.active]="avatar.hairStyle === style.value"
            (click)="avatar.hairStyle = style.value; onOptionChange()"
            class="btn-option">
            {{ style.name }}
          </button>
        </div>
      </div>

      <!-- Shirt Color -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'shirtColor'">
        <label class="option-label">Color de Camiseta</label>
        <div class="color-grid color-grid-extended">
          <button
            *ngFor="let color of shirtColors"
            [class.active]="avatar.shirtColor === color.value"
            (click)="avatar.shirtColor = color.value; onOptionChange()"
            class="color-option"
            [style.background-color]="color.value"
            [style.color]="color.value === '#FFFFFF' || color.value === '#F1C40F' ? '#000' : '#FFF'"
            [attr.aria-label]="color.name">
            <span class="color-name">{{ color.name }}</span>
          </button>
        </div>
      </div>

      <!-- Shirt Type -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'shirtType'">
        <label class="option-label">Tipo de Prenda Superior</label>
        <div class="button-group">
          <button
            *ngFor="let type of shirtTypes"
            [class.active]="avatar.shirtType === type.value"
            (click)="avatar.shirtType = type.value; onOptionChange()"
            class="btn-option">
            {{ type.name }}
          </button>
        </div>
      </div>

      <!-- Pants Color -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'pantsColor'">
        <label class="option-label">Color de Parte Inferior</label>
        <div class="color-grid color-grid-extended">
          <button
            *ngFor="let color of pantsColors"
            [class.active]="avatar.pantsColor === color.value"
            (click)="avatar.pantsColor = color.value; onOptionChange()"
            class="color-option"
            [style.background-color]="color.value"
            [style.color]="color.value === '#FFFFFF' ? '#000' : '#FFF'"
            [attr.aria-label]="color.name">
            <span class="color-name">{{ color.name }}</span>
          </button>
        </div>
      </div>

      <!-- Pants Type -->
      <div class="option-group" *ngIf="currentCustomizationOption === 'pantsType'">
        <label class="option-label">Tipo de Prenda Inferior</label>
        <div class="button-group">
          <button
            *ngFor="let type of pantsTypes"
            [class.active]="avatar.pantsType === type.value"
            (click)="avatar.pantsType = type.value; onOptionChange()"
            class="btn-option">
            {{ type.name }}
          </button>
        </div>
      </div>

      <!-- Accessories -->
      <div class="option-group accessories-group" *ngIf="currentCustomizationOption === 'accessories'">
        <label class="option-label">Accesorios (Opcionales)</label>
        <div class="accessories-container">
          <label class="accessory-checkbox">
            <input
              type="checkbox"
              [(ngModel)]="avatar.glasses"
              (change)="onOptionChange()">
            <span class="accessory-label">ğŸ‘“ Gafas</span>
          </label>

          <label class="accessory-checkbox">
            <input
              type="checkbox"
              [(ngModel)]="avatar.headBandana"
              (change)="onOptionChange()">
            <span class="accessory-label">ğŸ€ PaÃ±oleta en el Cabello</span>
          </label>

          <label class="accessory-checkbox">
            <input
              type="checkbox"
              [(ngModel)]="avatar.chestBandana"
              (change)="onOptionChange()">
            <span class="accessory-label">ğŸ§£ PaÃ±oleta en el Pecho</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer">
    <p>{{ currentYear }} Â® Te protejo</p>
  </footer>
</div>

<!-- Core Value Popup -->
<div class="popup-overlay" *ngIf="showCoreValuePopup" (click)="closeCoreValuePopup()">
  <div class="popup-content" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h2>ğŸŒŸ Elige tu Valor Clave</h2>
      <p class="popup-subtitle">Selecciona el compromiso que mÃ¡s te identifica como guardiÃ¡n/a del campus</p>
    </div>

    <div class="core-values-grid">
      <button
        *ngFor="let value of coreValues"
        (click)="selectCoreValue(value.name)"
        class="core-value-card">
        <div class="value-icon">{{ value.icon }}</div>
        <h3 class="value-name">{{ value.name }}</h3>
        <p class="value-description">{{ value.description }}</p>
      </button>
    </div>
  </div>
</div>